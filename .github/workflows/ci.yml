name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  shell-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Shell syntax check
        run: |
          bash -n install.sh \
            configs/wallpaper-colors/theme_watcher.sh \
            configs/wallpaper-colors/wallpaper_cycle.sh \
            configs/wallpaper-colors/borders-cycle.sh \
            configs/wallpaper-colors/next-wallpaper.sh \
            configs/wallpaper-colors/setup-targets.sh \
            configs/sketchybar/sketchybarrc \
            configs/sketchybar/plugins/*.sh

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: |
          shellcheck -S error install.sh \
            configs/wallpaper-colors/theme_watcher.sh \
            configs/wallpaper-colors/wallpaper_cycle.sh \
            configs/wallpaper-colors/borders-cycle.sh \
            configs/wallpaper-colors/next-wallpaper.sh \
            configs/wallpaper-colors/setup-targets.sh \
            configs/sketchybar/sketchybarrc \
            configs/sketchybar/plugins/*.sh

  python-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install ruff
        run: python -m pip install --upgrade pip ruff

      - name: Run ruff
        run: |
          ruff check --select F \
            configs/wallpaper-colors/wcsync \
            configs/wallpaper-colors/wallpaper_colors.py \
            tests

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: python -m pip install --upgrade pip Pillow

      - name: Run unit tests
        run: python -m unittest discover -s tests -p 'test_*.py' -v

  cli-flow-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: python -m pip install --upgrade pip Pillow

      - name: Run CLI flow tests
        run: python -m unittest discover -s tests -p 'test_main_flow.py' -v

  installer-smoke:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install installer deps (Pillow, PyObjC, desktoppr)
        run: |
          python -m pip install --upgrade pip Pillow pyobjc-framework-Quartz
          brew install desktoppr

      - name: Run installer (sandboxed home)
        run: |
          export WTS_INSTALL_HOME="$RUNNER_TEMP/wts-install"
          mkdir -p "$WTS_INSTALL_HOME"
          bash install.sh

      - name: Verify deployed paths
        run: |
          HOME="$RUNNER_TEMP/wts-install"
          CONFIG="$HOME/.config/wallpaper-colors"
          BIN="$HOME/.local/bin"
          LAUNCH="$HOME/Library/LaunchAgents"
          test -f "$CONFIG/wallpaper_colors.py"
          test -d "$CONFIG/wcsync"
          test -f "$CONFIG/theme_watcher.sh"
          test -f "$CONFIG/wallpaper_cycle.sh"
          test -f "$CONFIG/setup-targets.sh"
          test -f "$BIN/WallpaperFaded.app/Contents/MacOS/wallpaper-faded"
          test -f "$BIN/WallpaperFade.app/Contents/MacOS/wallpaper-fade"
          for name in wallpaper-colors theme-watcher wallpaper-cycle borders; do
            test -f "$LAUNCH/com.walbridge.$name.plist"
          done
          test -d "$HOME/.local/share/borders"

  macos-validation:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: python -m pip install --upgrade pip -r requirements.txt

      - name: Run unit tests
        run: python -m unittest discover -s tests -p 'test_*.py' -v

      - name: Verify macOS Quartz runtime
        run: |
          python -c "import Quartz"
          PYTHONPATH=configs/wallpaper-colors python -c "from wcsync.capture import get_display_count; assert get_display_count() >= 0"

      - name: Swift compile check
        run: |
          mkdir -p /tmp/clang-module-cache /tmp/swift-module-cache /tmp/wts-build
          CLANG_MODULE_CACHE_PATH=/tmp/clang-module-cache \
          SWIFT_MODULECACHE_PATH=/tmp/swift-module-cache \
          swiftc -O tools/wallpaper-fade.swift \
            -o /tmp/wts-build/wallpaper-fade \
            -framework AppKit -framework QuartzCore -framework ScreenCaptureKit
          CLANG_MODULE_CACHE_PATH=/tmp/clang-module-cache \
          SWIFT_MODULECACHE_PATH=/tmp/swift-module-cache \
          swiftc -O tools/wallpaper-faded.swift \
            -o /tmp/wts-build/wallpaper-faded \
            -framework AppKit -framework QuartzCore

      - name: Swift runtime smoke (daemon starts without crash)
        run: |
          ( /tmp/wts-build/wallpaper-faded & pid=$!; sleep 2; kill $pid 2>/dev/null || true; wait $pid 2>/dev/null || true )
          ( /tmp/wts-build/wallpaper-fade & pid=$!; sleep 2; kill $pid 2>/dev/null || true; wait $pid 2>/dev/null || true )
