#!/usr/bin/env bash
# Enforce Conventional Commits format:
#   type(scope): description
#   type: description
#
# Valid types: feat, fix, refactor, build, ci, chore, docs, style, perf, test
# Scope is optional. Description must start lowercase, no trailing period.
#
# Setup: git config core.hooksPath .githooks

set -euo pipefail

commit_msg_file="$1"
commit_msg=$(head -1 "$commit_msg_file")

# Allow merge commits and fixup/squash commits
skip_pattern='^(Merge |fixup! |squash! |amend! |Revert )'
if [[ "$commit_msg" =~ $skip_pattern ]]; then
    exit 0
fi

# Conventional Commits regex
pattern='^(feat|fix|refactor|build|ci|chore|docs|style|perf|test)(\(.+\))?!?: .+'

if ! [[ "$commit_msg" =~ $pattern ]]; then
    echo "ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "  Expected: type(scope): description"
    echo "  Got:      $commit_msg"
    echo ""
    echo "  Valid types: feat, fix, refactor, build, ci, chore, docs, style, perf, test"
    echo "  Examples:"
    echo "    feat: add multi-monitor support"
    echo "    fix(capture): retry on CGWindowListCreateImage failure"
    echo "    refactor: modularize wallpaper_colors.py into wcsync package"
    echo ""
    exit 1
fi
